<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Envio de Vistorias – MSE Engenharia</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing:border-box; margin:0; padding:0 }
    body { font-family:'Inter',sans-serif; background:#f0f2f5; color:#333 }
    header { background:#d60000; padding:16px; text-align:center }
    main { max-width:900px; margin:24px auto; background:#fff; border-radius:8px; overflow:hidden }
    section { padding:24px; border-bottom:1px solid #eee }
    section:last-child { border-bottom:none }
    h2 { font-size:1.25rem; color:#555; margin-bottom:16px }
    label { display:block; margin-top:12px; font-weight:600; text-transform:uppercase; color:#555 }
    input,select,textarea { width:100%; padding:8px; margin-top:6px; border:1px solid #ccc; border-radius:6px }
    textarea { resize:vertical; min-height:80px }
    .comodos-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:16px }
    .comodo { background:#fafafa; padding:16px; border:1px solid #ddd; border-radius:6px }
    .comodo h3 { font-size:1rem; text-align:center; color:#444; text-transform:uppercase; margin-bottom:8px }
    .image-preview { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
    .thumb { position:relative; width:70px; height:70px; border-radius:4px; overflow:hidden; border:1px solid #ccc }
    .thumb img { width:100%; height:100%; object-fit:cover }
    .thumb button { position:absolute; top:2px; right:2px; background:rgba(255,255,255,0.8); border:none; border-radius:50%; width:20px; height:20px; font-size:14px; color:#d60000; cursor:pointer }
    button[type="submit"] { display:block; margin:24px auto; padding:12px 24px; background:#d60000; color:#fff; border:none; border-radius:6px; text-transform:uppercase; font-weight:600; cursor:pointer }
    button[type="submit"]:hover { background:#a90000 }
    #loading { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); align-items:center; justify-content:center; z-index:100 }
    #loading.active { display:flex }
    #loading span { background:#fff; padding:16px 24px; border-radius:6px; font-size:1rem }
    footer { text-align:center; padding:16px; color:#777; font-size:.875rem }
    @media(max-width:600px){ main{margin:16px} }
  </style>
</head>
<body>

  <header>
    <img src="logo.png" alt="MSE Engenharia" style="height:50px" />
  </header>

  <div id="loading"><span>Processando...</span></div>

  <main>
    <form id="form" autocomplete="off">
      <section>
        <h2>Dados do Responsável</h2>
        <label for="nome">Nome do Locador</label>
        <input id="nome" type="text" required />

        <label for="email">E-mail do Locador</label>
        <input id="email" type="email" required />

        <label for="nome-vistoriador">Nome do Vistoriador (ADM)</label>
        <input id="nome-vistoriador" type="text" required />

        <label for="email-locador">E-mail do Vistoriador</label>
        <input id="email-locador" type="email" required />

        <label for="cidade">Cidade para Data</label>
        <input id="cidade" type="text" required />

        <div style="display:flex; gap:8px;">
          <div style="flex:1">
            <label for="dia">Dia</label>
            <select id="dia" required>
              <option value="">Dia</option>
              <option>1</option><option>2</option><option>3</option><option>4</option>
              <option>5</option><option>6</option><option>7</option><option>8</option>
              <option>9</option><option>10</option><option>11</option><option>12</option>
              <option>13</option><option>14</option><option>15</option><option>16</option>
              <option>17</option><option>18</option><option>19</option><option>20</option>
              <option>21</option><option>22</option><option>23</option><option>24</option>
              <option>25</option><option>26</option><option>27</option><option>28</option>
              <option>29</option><option>30</option><option>31</option>
            </select>
          </div>
          <div style="flex:2">
            <label for="mes">Mês</label>
            <select id="mes" required>
              <option value="">Mês</option>
              <option value="janeiro">Janeiro</option>
              <option value="fevereiro">Fevereiro</option>
              <option value="março">Março</option>
              <option value="abril">Abril</option>
              <option value="maio">Maio</option>
              <option value="junho">Junho</option>
              <option value="julho">Julho</option>
              <option value="agosto">Agosto</option>
              <option value="setembro">Setembro</option>
              <option value="outubro">Outubro</option>
              <option value="novembro">Novembro</option>
              <option value="dezembro">Dezembro</option>
            </select>
          </div>
          <div style="flex:1">
            <label for="ano">Ano</label>
            <select id="ano" required>
              <option value="">Ano</option>
              <option>2020</option><option>2021</option><option>2022</option>
              <option>2023</option><option>2024</option><option>2025</option>
              <option>2026</option><option>2027</option><option>2028</option>
              <option>2029</option><option>2030</option><option>2031</option>
              <option>2032</option><option>2033</option><option>2034</option>
              <option>2035</option><option>2036</option><option>2037</option>
              <option>2038</option><option>2039</option><option>2040</option>
              <option>2041</option><option>2042</option><option>2043</option>
              <option>2044</option><option>2045</option><option>2046</option>
              <option>2047</option><option>2048</option><option>2049</option>
              <option>2050</option><option>2051</option><option>2052</option>
              <option>2053</option><option>2054</option><option>2055</option>
              <option>2056</option><option>2057</option><option>2058</option>
              <option>2059</option><option>2060</option><option>2061</option>
              <option>2062</option><option>2063</option><option>2064</option>
              <option>2065</option><option>2066</option><option>2067</option>
              <option>2068</option><option>2069</option><option>2070</option>
            </select>
          </div>
        </div>

        <label for="obra">Obra / Projeto</label>
        <input id="obra" type="text" required />

        <label for="local">Local da Vistoria</label>
        <input id="local" type="text" required />

        <label for="obs-gerais">Observações Gerais</label>
        <textarea id="obs-gerais"></textarea>
      </section>

      <section>
        <h2>Fotos por Cômodo</h2>
        <div class="comodos-grid" id="grid"></div>
        <button type="submit">Enviar Vistoria</button>
      </section>
    </form>
  </main>

  <footer>© 2025 MSE Engenharia</footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const comodos = [
      'Porta de Entrada','Sala de Estar','Cozinha','Quintal','Lavanderia','Garagem',
      'Quarto 1','Quarto 2','Quarto 3','Quarto 4','Quarto 5',
      'Suíte 1','Suíte 2','Suíte 3','Suíte 4','Suíte 5',
      'WC Social 1','WC Social 2','WC Social 3'
    ];
    const fotosPorComodo = {}, textareasPorComodo = {};
    const grid = document.getElementById('grid'),
          overlay = document.getElementById('loading');

    comodos.forEach(name => {
      fotosPorComodo[name] = [];
      const div = document.createElement('div');
      div.className = 'comodo';
      div.innerHTML = `
        <h3>${name.toUpperCase()}</h3>
        <input type="file" accept="image/*" multiple/>
        <div class="image-preview"></div>
        <label>Observações</label>
        <textarea></textarea>
      `;
      const input = div.querySelector('input'),
            preview = div.querySelector('.image-preview'),
            ta = div.querySelector('textarea');
      textareasPorComodo[name] = ta;
      input.addEventListener('change', e => {
        Array.from(e.target.files).forEach(f => fotosPorComodo[name].push(f));
        renderPreview(name, preview);
        input.value = '';
      });
      grid.appendChild(div);
    });

    function renderPreview(name, container) {
      container.innerHTML = '';
      fotosPorComodo[name].forEach((file,i) => {
        const thumb = document.createElement('div');
        thumb.className = 'thumb';
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        const btn = document.createElement('button');
        btn.textContent = '×';
        btn.onclick = () => { fotosPorComodo[name].splice(i,1); renderPreview(name,container) };
        thumb.append(img,btn);
        container.appendChild(thumb);
      });
    }

    document.getElementById('form').addEventListener('submit', async e => {
      e.preventDefault();
      overlay.classList.add('active');
      try {
        const data = {
          nome: document.getElementById('nome').value,
          email: document.getElementById('email').value,
          cidade: document.getElementById('cidade').value,
          dia: document.getElementById('dia').value,
          mes: document.getElementById('mes').value,
          ano: document.getElementById('ano').value,
          obra: document.getElementById('obra').value,
          local: document.getElementById('local').value,
          obsGerais: document.getElementById('obs-gerais').value,
          comodos: []
        };
        for (const name of comodos) {
          const imgs = await Promise.all(
            fotosPorComodo[name].map(f => new Promise(r=>{
              const fr=new FileReader();
              fr.onload=ev=>r(ev.target.result);
              fr.readAsDataURL(f);
            }))
          );
          data.comodos.push({ name, imgs, obs: textareasPorComodo[name].value });
        }

        const nomeVist  = document.getElementById('nome-vistoriador').value;
        const emailVist = document.getElementById('email-locador').value;
        const signers = [
          { name:'Matheus Dias',    email:'matheus.dias@mse.com.br', send_automatic_email:true, x:100,y:600,width:200,height:50,page:1 },
          { name:nomeVist,          email:emailVist,                 send_automatic_email:true, x:100,y:660,width:200,height:50,page:1 },
          { name:data.nome,         email:data.email,                send_automatic_email:true, x:100,y:720,width:200,height:50,page:1 }
        ];

        await generateAndSend(data, signers);
        alert('Envelope enviado para assinatura!');
      } catch (err) {
        console.error(err);
        alert('Erro ao enviar: '+err.message);
      } finally {
        overlay.classList.remove('active');
      }
    });

    async function generateAndSend(data, signers) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });
      const w = doc.internal.pageSize.getWidth(),
            h = doc.internal.pageSize.getHeight(),
            m = 40;
      let y = m;

      // Título
      doc.setFillColor(214,0,0).rect(m, y+40, w-2*m, 30, 'F');
      doc.setFont('helvetica','bold').setFontSize(20).setTextColor(255);
      doc.text('FICHA DE VISTORIA', w/2, y+62, { align:'center' });
      doc.setFont('helvetica','normal').setFontSize(12).setTextColor(0);
      y += 100;

      // Dados
      const boxY = y, lh = 24;
      doc.setDrawColor(214,0,0).setLineWidth(1.2).rect(m, boxY, w-2*m, lh*4+10);
      doc.text('Nome:', m+10, boxY+lh);
      doc.text(data.nome, m+80, boxY+lh);
      doc.text('E-mail:', m+10, boxY+lh*2);
      doc.text(data.email, m+80, boxY+lh*2);
      doc.text('Obra / Projeto:', m+10, boxY+lh*3);
      doc.text(data.obra, m+110, boxY+lh*3);
      doc.text('Local:', m+10, boxY+lh*4);
      doc.text(data.local, m+80, boxY+lh*4);

      // Observações
      const obsY = boxY + lh*4 + 30;
      doc.setFillColor('#f7f7f7').rect(m, obsY, w-2*m, 60, 'F');
      doc.setDrawColor(214,0,0).rect(m, obsY, w-2*m, 20);
      doc.setFont('helvetica','bold').setFontSize(14).text('Observações Gerais', m+10, obsY+14);
      doc.setFont('helvetica','normal').setFontSize(12).text(data.obsGerais||'-', m+10, obsY+35, { maxWidth: w-2*m-20 });

      // Assinaturas (primeira linha 120px abaixo das observações)
      const lineW = 250;
      doc.setDrawColor(214,0,0).setLineWidth(1.2);
      const firstY  = obsY + 120;
      const secondY = firstY + 80;
      const thirdY  = secondY + 80;

      doc.line(w/2-lineW/2, firstY,  w/2+lineW/2, firstY);
      doc.text('VISTORIADOR - MSE ENGENHARIA', w/2, firstY+15, { align:'center' });

      doc.line(w/2-lineW/2, secondY, w/2+lineW/2, secondY);
      doc.text('LOCATÁRIO', w/2, secondY+15, { align:'center' });

      doc.line(w/2-lineW/2, thirdY,  w/2+lineW/2, thirdY);
      doc.text('LOCADOR', w/2, thirdY+15, { align:'center' });

      // Data no rodapé
      const dateText = `${data.cidade}, ${data.dia} de ${data.mes} de ${data.ano}`;
      doc.setFont('helvetica','normal').setFontSize(12).setTextColor(100);
      doc.text(dateText, w-m, h-40, { align:'right' });

      // Páginas de fotos
      for (const com of data.comodos) {
        for (const img of com.imgs) {
          doc.addPage();
          doc.setFont('helvetica','bold').setFontSize(16).setTextColor(214,0,0)
             .text(com.name.toUpperCase(), w/2, m, { align:'center' });
          if (com.obs) {
            doc.setFont('helvetica','normal').setFontSize(12).text(com.obs, w/2, m+20, { align:'center', maxWidth: w-2*m });
          }
          const props = doc.getImageProperties(img),
                iw = w-2*m,
                ih = (props.height*iw)/props.width,
                type = img.includes('png')?'PNG':'JPEG';
          doc.addImage(img, type, m, m+40, iw, ih);
        }
      }

      const pdfDataUrl = doc.output('dataurlstring');
      await fetch('/api/zapsign', {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ pdfDataUrl, signers })
      });
    }
  </script>
</body>
</html>
