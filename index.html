<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Envio de Vistorias – MSE Engenharia</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter',sans-serif; background: #f0f2f5; color: #333; }
    header { background: #d60000; padding: 16px; text-align: center; }
    main { max-width: 930px; margin: 24px auto; background: #fff; border-radius: 12px; box-shadow: 0 3px 18px #0002; overflow: hidden; }
    section { padding: 28px 28px 20px 28px; border-bottom: 1px solid #eee; }
    section:last-child { border-bottom: none; }
    h2 { font-size: 1.25rem; color: #d60000; margin-bottom: 18px; }
    label { display: block; margin-top: 14px; font-weight: 600; text-transform: uppercase; color: #555; }
    input,select,textarea { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 7px; font-size: 1rem;}
    textarea { resize: vertical; min-height: 80px;}
    .comodos-grid { display: flex; flex-direction: column; gap: 28px; }
    .comodo { background: #fafafa; padding: 18px 18px 28px 18px; border: 1.6px solid #eee; border-radius: 8px; box-shadow: 0 2px 10px #d6000016; margin-bottom: 18px; }
    .comodo h3 {
      font-size: 1.14rem; margin-bottom: 0;
      background: #d60000; color: #fff;
      padding: 9px 0 9px 12px;
      border-radius: 6px 6px 0 0;
      text-transform: uppercase;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .item-avaliacao-grid {
      display: grid;
      grid-template-columns: 1.3fr 1fr 1.3fr 0.7fr;
      gap: 8px; align-items: center;
      margin-bottom: 2px;
    }
    .item-avaliacao-header {
      font-weight: 700; background: #f1f1f1; color: #d60000;
      padding: 6px 0 6px 8px; border-radius: 5px;
      text-align: left;
      font-size: 1rem;
    }
    .avaria-preview, .fotos-preview {
      display: flex; flex-wrap: wrap; gap: 9px; margin: 8px 0 0 0;
    }
    .avaria-thumb, .foto-thumb {
      position: relative; width: 67px; height: 67px; border: 1.5px solid #d60000; border-radius: 7px; overflow: hidden; background: #fff;
      box-shadow: 0 2px 10px #d6000016;
      display: flex; align-items: center; justify-content: center;
      transition: box-shadow .18s;
    }
    .avaria-thumb img, .foto-thumb img { width: 100%; height: 100%; object-fit: cover; transition: transform .13s; }
    .avaria-thumb:hover img, .foto-thumb:hover img { transform: scale(1.07) rotate(-3deg); }
    .thumb-remove, .foto-thumb-remove {
      position: absolute; top: 4px; right: 4px; width: 22px; height: 22px;
      background: #fff; border-radius: 50%; border: 1.7px solid #d60000;
      color: #d60000; font-weight: 900; font-size: 1.17rem; line-height: 20px;
      text-align: center; cursor: pointer; transition: .15s;
      box-shadow: 0 2px 8px #d6000020;
    }
    .thumb-remove:hover, .foto-thumb-remove:hover { background: #d60000; color: #fff; }
    .foto-btn, .file-btn {
      background: #d60000; color: #fff; font-weight: 700;
      border: none; border-radius: 7px; padding: 10px 20px;
      font-size: 1.14rem; margin-top: 6px; cursor: pointer;
      transition: background .16s, box-shadow .16s;
      box-shadow: 0 2px 12px #d6000011; display: inline-block;
    }
    .foto-btn:hover, .file-btn:hover { background: #b30000; }
    .file-btn input[type="file"] { display: none; }
    .foto-label { color: #d60000; font-weight: 600; margin-top: 11px; }
    .obs-input { margin-top: 14px; }
    .moveis-bloco { background: #fafafa; border: 1.5px solid #eee; border-radius: 9px; padding: 26px 24px; margin: 30px 0 14px 0; }
    .movel-linha { display: flex; flex-wrap: wrap; align-items: center; gap: 14px; margin-bottom: 14px; }
    .movel-linha input, .movel-linha select { margin: 0; font-size: 1rem; }
    .movel-desc { flex: 2 1 220px; }
    .movel-comodo, .movel-estado { flex: 1 1 120px; }
    .movel-foto-btn { flex: 1 1 130px; }
    .movel-fotos-preview { flex: 1 1 125px; display: flex; gap: 7px;}
    .movel-remover { margin-left: 12px; }
    .movel-add-btn {
      margin-top: 8px; margin-bottom: 0;
      background: #d60000; color: #fff; border: none; border-radius: 7px;
      font-weight: 700; font-size: 1.1rem; padding: 10px 28px; cursor: pointer;
      transition: background .14s; box-shadow: 0 2px 10px #d6000011;
    }
    .movel-add-btn:hover { background: #b30000; }
    select { appearance: none; background: #fff url('data:image/svg+xml;utf8,<svg fill="gray" height="20" viewBox="0 0 20 20" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M5.516 7.548c-.316-.32-.838-.325-1.154-.005a.794.794 0 000 1.12l4.365 4.417c.31.314.826.314 1.135 0l4.367-4.417a.794.794 0 000-1.12c-.316-.32-.838-.325-1.154-.005L10 10.324 5.516 7.548z"/></svg>') right 10px center/16px 16px no-repeat; }
    @media (max-width: 750px){
      main { margin: 4px; }
      .item-avaliacao-grid { grid-template-columns: 1fr 1fr 1fr 1fr; font-size: 0.98rem;}
      .movel-linha { flex-direction: column; align-items: stretch;}
      .moveis-bloco { padding: 10px 8px; }
      .movel-add-btn, .foto-btn { width: 100%; font-size: 1.16rem; padding: 15px 0;}
      section {padding: 16px 6px 10px 6px;}
    }

    /* Overlay de carregamento */
    #loading-overlay{
      display:none; position:fixed; inset:0; background:rgba(255,255,255,.9);
      justify-content:center; align-items:center; z-index:9999;
    }
    @keyframes spin { to { transform: rotate(360deg) } }
    .spinner{
      width:56px;height:56px;border-radius:50%;
      border:6px solid #d60000;border-right-color:transparent;
      animation:spin .9s linear infinite;margin:0 auto 10px;
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="MSE Engenharia" style="height:48px;" />
  </header>

  <main>
    <form id="form" autocomplete="off">
      <section>
        <h2>Dados do Responsável</h2>
        <label for="tipo-vistoria">Tipo de Vistoria</label>
        <select id="tipo-vistoria" required>
          <option value="">Selecione</option>
          <option value="entrada">Vistoria de Entrada</option>
          <option value="saida">Vistoria de Saída</option>
        </select>
        <label for="nome">Nome do Locador</label>
        <input id="nome" type="text" required>
        <label for="email">E-mail do Locador</label>
        <input id="email" type="email" required>
        <label for="nome-vistoriador">Nome do Vistoriador (ADM)</label>
        <input id="nome-vistoriador" type="text" required>
        <label for="email-locador">E-mail do Vistoriador</label>
        <input id="email-locador" type="email" required>
        <label for="cidade">Cidade</label>
        <input id="cidade" type="text" required>
        <div style="display: flex; gap: 8px;">
          <div style="flex:1">
            <label for="dia">Dia</label>
            <select id="dia" required>
              <option value="">Dia</option>
              <script>for(let i=1;i<=31;i++)document.write(`<option>${i}</option>`);</script>
            </select>
          </div>
          <div style="flex:2">
            <label for="mes">Mês</label>
            <select id="mes" required>
              <option value="">Mês</option>
              <option value="janeiro">Janeiro</option>
              <option value="fevereiro">Fevereiro</option>
              <option value="março">Março</option>
              <option value="abril">Abril</option>
              <option value="maio">Maio</option>
              <option value="junho">Junho</option>
              <option value="julho">Julho</option>
              <option value="agosto">Agosto</option>
              <option value="setembro">Setembro</option>
              <option value="outubro">Outubro</option>
              <option value="novembro">Novembro</option>
              <option value="dezembro">Dezembro</option>
            </select>
          </div>
          <div style="flex:1">
            <label for="ano">Ano</label>
            <select id="ano" required>
              <option value="">Ano</option>
              <script>let anoAtual=new Date().getFullYear();for(let a=anoAtual-1;a<=anoAtual+6;a++)document.write(`<option>${a}</option>`);</script>
            </select>
          </div>
        </div>
        <label for="obra">Obra / Projeto</label>
        <input id="obra" type="text" required>
        <label for="local">Local da Vistoria</label>
        <textarea id="local" rows="3" required></textarea>
        <label for="obs-gerais">Observações Gerais</label>
        <textarea id="obs-gerais" rows="3"></textarea>
      </section>

      <section>
        <h2>Fotos e Avaliação por Cômodo</h2>
        <div class="comodos-grid" id="grid"></div>
      </section>

      <section>
        <h2>Móveis / Itens Adicionais</h2>
        <div class="moveis-bloco" id="moveis-bloco"></div>
        <button class="movel-add-btn" type="button" id="btn-add-movel">+ Adicionar móvel</button>
      </section>

      <div style="display:flex; justify-content:center;">
        <button type="submit" class="foto-btn" style="margin-bottom:32px; min-width:220px;">Enviar Vistoria</button>
      </div>
    </form>
  </main>

  <footer>© 2025 MSE Engenharia</footer>

  <!-- Overlay de carregamento -->
  <div id="loading-overlay">
    <div style="text-align:center;">
      <div class="spinner"></div>
      <strong style="color:#d60000">Gerando PDF...</strong>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

  <script>
    // ========== ITENS E CÔMODOS ==========
    const ITENS_COMODO = {
      'Porta de Entrada': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portões, Portas e Janelas','Luminárias, tomadas e interruptores','Vidros e Espelhos','Possui mobília e/ou acessórios?'],
      'Sala de Estar': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portas e Janelas','Luminárias, tomadas e interruptores','Vidros e Espelhos','Possui mobília e/ou acessórios?'],
      'Cozinha': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portas e Janelas','Luminárias, tomadas e interruptores','Pia, Torneiras, Sifão','Possui mobília e/ou acessórios?'],
      'Quintal': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portões, Portas e Janelas','Luminárias, tomadas e interruptores','Vidros e Espelhos','Possui mobília e/ou acessórios?'],
      'Lavanderia': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portas e Janelas','Luminárias, tomadas e interruptores','Tanque, Torneiras, Sifão, Ralos','Possui mobília e/ou acessórios?'],
      'Garagem': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portões, Portas e Janelas','Luminárias, tomadas e interruptores','Vidros e Espelhos','Possui mobília e/ou acessórios?'],
      'Quarto 1': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portas e Janelas','Luminárias, tomadas e interruptores','Vidros e Espelhos','Possui mobília e/ou acessórios?'],
      'Quarto 2': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portas e Janelas','Luminárias, tomadas e interruptores','Vidros e Espelhos','Possui mobília e/ou acessórios?'],
      'Quarto 3': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portas e Janelas','Luminárias, tomadas e interruptores','Vidros e Espelhos','Possui mobília e/ou acessórios?'],
      'Quarto 4': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portas e Janelas','Luminárias, tomadas e interruptores','Vidros e Espelhos','Possui mobília e/ou acessórios?'],
      'Quarto 5': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portas e Janelas','Luminárias, tomadas e interruptores','Vidros e Espelhos','Possui mobília e/ou acessórios?'],
      'Suíte 1': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portas e Janelas','Luminárias, tomadas e interruptores','Pia, Torneiras, Sifão','Vidros, Espelhos e Acessórios (porta toalhas, etc)','Vaso Sanitário, Válvula Descarga','Box, Chuveiro, Ralo','Possui mobília e/ou acessórios?'],
      'Suíte 2': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portas e Janelas','Luminárias, tomadas e interruptores','Pia, Torneiras, Sifão','Vidros, Espelhos e Acessórios (porta toalhas, etc)','Vaso Sanitário, Válvula Descarga','Box, Chuveiro, Ralo','Possui mobília e/ou acessórios?'],
      'Suíte 3': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portas e Janelas','Luminárias, tomadas e interruptores','Pia, Torneiras, Sifão','Vidros, Espelhos e Acessórios (porta toalhas, etc)','Vaso Sanitário, Válvula Descarga','Box, Chuveiro, Ralo','Possui mobília e/ou acessórios?'],
      'Suíte 4': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portas e Janelas','Luminárias, tomadas e interruptores','Pia, Torneiras, Sifão','Vidros, Espelhos e Acessórios (porta toalhas, etc)','Vaso Sanitário, Válvula Descarga','Box, Chuveiro, Ralo','Possui mobília e/ou acessórios?'],
      'Suíte 5': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portas e Janelas','Luminárias, tomadas e interruptores','Pia, Torneiras, Sifão','Vidros, Espelhos e Acessórios (porta toalhas, etc)','Vaso Sanitário, Válvula Descarga','Box, Chuveiro, Ralo','Possui mobília e/ou acessórios?'],
      'WC Social 1': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portas e Janelas','Luminárias, tomadas e interruptores','Pia, Torneiras, Sifão','Vidros, Espelhos e Acessórios (porta toalhas, etc)','Vaso Sanitário, Válvula Descarga','Box, Chuveiro, Ralo','Possui mobília e/ou acessórios?'],
      'WC Social 2': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portas e Janelas','Luminárias, tomadas e interruptores','Pia, Torneiras, Sifão','Vidros, Espelhos e Acessórios (porta toalhas, etc)','Vaso Sanitário, Válvula Descarga','Box, Chuveiro, Ralo','Possui mobília e/ou acessórios?'],
      'WC Social 3': ['Paredes/Revestimento/Pintura','Pisos e Rodapés','Teto','Portas e Janelas','Luminárias, tomadas e interruptores','Pia, Torneiras, Sifão','Vidros, Espelhos e Acessórios (porta toalhas, etc)','Vaso Sanitário, Válvula Descarga','Box, Chuveiro, Ralo','Possui mobília e/ou acessórios?'],
    };
    const ESTADOS = ["Novo/Nunca usado","Bom","Regular","Ruim","Não Aplicável"];
    const SIM_NAO = ["Sim","Não"];
    const comodos = Object.keys(ITENS_COMODO);

    // ====== DADOS DOS CÔMODOS ======
    const grid = document.getElementById('grid');
    const dadosComodos = {};
    comodos.forEach(comodoNome => {
      dadosComodos[comodoNome] = { fotos: [], avaliacao: {}, avarias: {}, comentarios: "" };
      const div = document.createElement('div');
      div.className = 'comodo';
      let html = `<h3>${comodoNome.toUpperCase()}</h3>
      <div class="item-avaliacao-grid">
        <div class="item-avaliacao-header">Item</div>
        <div class="item-avaliacao-header">Estado de Conservação</div>
        <div class="item-avaliacao-header">Avaria (fotos se Regular/Ruim)</div>
        <div class="item-avaliacao-header">Ação</div>
      </div>`;
      ITENS_COMODO[comodoNome].forEach(item => {
        const id = `${comodoNome}_${item}`.replace(/[^\w]/g, '_');
        html += `<div class="item-avaliacao-grid" data-item="${item}">
          <div>${item}</div>
          <div>
            <select onchange="window.onAvaliacaoChange('${comodoNome}','${item}',this)">
              <option value="">Selecione</option>
              ${
                item.toLowerCase().includes('mobília') || item.toLowerCase().includes('acessórios')
                ? SIM_NAO.map(e=>`<option value="${e}">${e}</option>`).join('')
                : ESTADOS.map(e=>`<option value="${e}">${e}</option>`).join('')
              }
            </select>
          </div>
          <div>
            <div class="avaria-preview" id="avaria_${id}"></div>
            <span class="file-btn" style="display:none;margin-top:2px;" id="btn_add_${id}" onclick="window.abrirFileAvaria('${comodoNome}','${item}')">+ Fotos</span>
            <input type="file" style="display:none" accept="image/*" capture="environment" multiple id="file_${id}" onchange="window.onAvariaFile('${comodoNome}','${item}',this)">
          </div>
          <div>
            <span class="thumb-remove" style="display:none;" id="btn_rm_${id}" onclick="window.removerAvaria('${comodoNome}','${item}')">&times;</span>
          </div>
        </div>`;
      });
      html += `<label class="obs-input">Observações</label><textarea onchange="dadosComodos['${comodoNome}'].comentarios=this.value"></textarea>`;
      html += `<label class="foto-label">FOTOS GERAIS DO CÔMODO</label>
        <span class="file-btn" onclick="window.abrirFileComodo('${comodoNome}')" style="margin-bottom:8px;">
          + Fotos
          <input type="file" accept="image/*" capture="environment" multiple id="file_geral_${comodoNome.replace(/[^\w]/g,'_')}" style="display:none" onchange="window.onFotoComodo('${comodoNome}',this)">
        </span>
        <div class="fotos-preview" id="preview_${comodoNome.replace(/[^\w]/g,'_')}"></div>`;
      div.innerHTML = html;
      grid.appendChild(div);
    });

    // NOVA FUNÇÃO para abrir o input file de fotos gerais
    window.abrirFileComodo = (comodo) => {
      document.getElementById('file_geral_'+comodo.replace(/[^\w]/g,'_')).click();
    };

    // Conversão/compressão universal para JPEG (qualidade 0.9)
    async function fileToJpegDataURL(file, maxSide=1600, quality=0.9) {
      // tenta decodificar como ImageBitmap (funciona para heic no iOS moderno)
      const bitmap = await createImageBitmap(file).catch(() => null);
      if (!bitmap) {
        // fallback: tenta ler como DataURL direto (pode falhar para HEIC antigo)
        return new Promise((res) => {
          const r = new FileReader();
          r.onload = () => res(r.result);
          r.readAsDataURL(file);
        });
      }
      const { width, height } = bitmap;
      const scale = Math.min(1, maxSide / Math.max(width, height));
      const w = Math.round(width * scale);
      const h = Math.round(height * scale);
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(bitmap, 0, 0, w, h);
      return canvas.toDataURL('image/jpeg', quality);
    }

    // --- FUNÇÕES CÔMODOS E AVARIAS ---
    window.onAvaliacaoChange = (comodo, item, sel) => {
      dadosComodos[comodo].avaliacao[item] = sel.value;
      const id = `${comodo}_${item}`.replace(/[^\w]/g, '_');
      const btnAdd = document.getElementById('btn_add_'+id);
      const btnRm  = document.getElementById('btn_rm_'+id);
      const fileInput = document.getElementById('file_'+id);
      if(sel.value === "Regular" || sel.value === "Ruim") {
        btnAdd.style.display = "inline-block";
        btnRm.style.display  = dadosComodos[comodo].avarias[item] && dadosComodos[comodo].avarias[item].length > 0 ? "inline-block" : "none";
      } else {
        btnAdd.style.display = "none";
        btnRm.style.display  = "none";
        dadosComodos[comodo].avarias[item] = [];
        fileInput.value = "";
        window.renderAvariaPreview(comodo, item);
      }
    };
    window.abrirFileAvaria = (comodo, item) => {
      const id = `${comodo}_${item}`.replace(/[^\w]/g, '_');
      document.getElementById('file_'+id).click();
    };
    window.onAvariaFile = async (comodo, item, input) => {
      if (!dadosComodos[comodo].avarias[item]) dadosComodos[comodo].avarias[item] = [];
      for (const file of Array.from(input.files)) {
        const dataURL = await fileToJpegDataURL(file, 1600, 0.9);
        dadosComodos[comodo].avarias[item].push(dataURL);
      }
      window.renderAvariaPreview(comodo, item);
      input.value = "";
    };
    window.removerAvaria = (comodo, item, idx = null) => {
      if (idx !== null) {
        dadosComodos[comodo].avarias[item].splice(idx,1);
      } else {
        dadosComodos[comodo].avarias[item] = [];
      }
      window.renderAvaria
      window.renderAvariaPreview(comodo, item);
      const id = `${comodo}_${item}`.replace(/[^\w]/g, '_');
      document.getElementById('btn_rm_'+id).style.display =
        dadosComodos[comodo].avarias[item] && dadosComodos[comodo].avarias[item].length > 0 ? "inline-block" : "none";
    };
    window.renderAvariaPreview = (comodo, item) => {
      const id = `${comodo}_${item}`.replace(/[^\w]/g, '_');
      const previewDiv = document.getElementById('avaria_'+id);
      previewDiv.innerHTML = '';
      const avarias = dadosComodos[comodo].avarias[item] || [];
      avarias.forEach((src, idx) => {
        const thumb = document.createElement('div');
        thumb.className = 'avaria-thumb';
        thumb.innerHTML = `<img src="${src}" alt="Avaria" />
          <span class="thumb-remove" onclick="window.removerAvaria('${comodo}','${item}',${idx})">&times;</span>`;
        previewDiv.appendChild(thumb);
      });
      const btnRm = document.getElementById('btn_rm_'+id);
      btnRm.style.display = avarias.length > 0 ? "inline-block" : "none";
    };

    // Fotos gerais dos cômodos (com conversão p/ JPEG)
    window.onFotoComodo = async (comodo, input) => {
      if (!dadosComodos[comodo].fotos) dadosComodos[comodo].fotos = [];
      for (const file of Array.from(input.files)) {
        const dataURL = await fileToJpegDataURL(file, 1600, 0.9);
        dadosComodos[comodo].fotos.push(dataURL);
      }
      renderFotoComodoPreview(comodo);
      input.value = "";
    };
    function renderFotoComodoPreview(comodo) {
      const id = comodo.replace(/[^\w]/g, '_');
      const previewDiv = document.getElementById('preview_'+id);
      previewDiv.innerHTML = '';
      (dadosComodos[comodo].fotos || []).forEach((src, idx) => {
        const thumb = document.createElement('div');
        thumb.className = 'foto-thumb';
        thumb.innerHTML = `<img src="${src}" alt="Foto Cômodo" />
            <span class="foto-thumb-remove" onclick="window.removerFotoComodo('${comodo}',${idx})">&times;</span>`;
        previewDiv.appendChild(thumb);
      });
    }
    window.removerFotoComodo = (comodo, idx) => {
      dadosComodos[comodo].fotos.splice(idx, 1);
      renderFotoComodoPreview(comodo);
    };

    // ====== MÓVEIS ======
    let moveis = [];
    function renderMoveis(){
      const bloco = document.getElementById('moveis-bloco');
      bloco.innerHTML = '';
      moveis.forEach((mov, i) => {
        let linha = document.createElement('div');
        linha.className = 'movel-linha';
        linha.innerHTML = `
          <input class="movel-desc" placeholder="Descrição do móvel/item" value="${mov.desc||""}" oninput="moveis[${i}].desc=this.value">
          <select class="movel-comodo" onchange="moveis[${i}].comodo=this.value">
            <option value="">Cômodo</option>
            ${comodos.map(c=>`<option value="${c}" ${c===mov.comodo?'selected':''}>${c}</option>`).join('')}
          </select>
          <select class="movel-estado" onchange="window.onEstadoMovel(${i},this)">
            <option value="">Estado de Conservação</option>
            ${ESTADOS.map(e=>`<option value="${e}" ${e===mov.estado?'selected':''}>${e}</option>`).join('')}
          </select>
          <span class="movel-foto-btn">
            ${(mov.estado === "Regular" || mov.estado === "Ruim")
              ? `<span class="file-btn" onclick="window.abrirFileMovel(${i})" style="padding:6px 16px;">
                  + Fotos de Avaria
                  <input type="file" accept="image/*" capture="environment" multiple style="display:none" id="file_movel_${i}" onchange="window.onFotoMovel(${i},this)">
                </span>`
              : ''}
          </span>
          <span class="movel-fotos-preview">
            ${(mov.fotos||[]).map((src,idx)=>`
                <span class="foto-thumb"><img src="${src}">
                <span class="foto-thumb-remove" onclick="window.removerFotoMovel(${i},${idx})">&times;</span></span>
            `).join('')}
          </span>
          <span class="thumb-remove movel-remover" onclick="window.removerMovel(${i})" title="Excluir móvel">&times;</span>
        `;
        bloco.appendChild(linha);
      });
    }
    window.abrirFileMovel = (i) => {
      document.getElementById('file_movel_'+i).click();
    };
    window.onEstadoMovel = (idx,sel) => {
      moveis[idx].estado = sel.value;
      if (sel.value === "Regular" || sel.value === "Ruim") {
        if (!moveis[idx].fotos) moveis[idx].fotos = [];
      } else {
        moveis[idx].fotos = [];
      }
      renderMoveis();
    };
    window.onFotoMovel = async (i,input) => {
      if (!moveis[i].fotos) moveis[i].fotos = [];
      for (const file of Array.from(input.files)) {
        const dataURL = await fileToJpegDataURL(file, 1600, 0.9);
        moveis[i].fotos.push(dataURL);
      }
      renderMoveis();
      input.value = '';
    };
    window.removerFotoMovel = (i,idx) => {
      moveis[i].fotos.splice(idx,1);
      renderMoveis();
    };
    window.removerMovel = (idx) => { moveis.splice(idx,1); renderMoveis(); };
    document.getElementById('btn-add-movel').onclick = () => {
      moveis.push({desc:'',comodo:'',estado:'',fotos:[]}); renderMoveis();
    };
    renderMoveis();

    // ========= SUBMIT + OVERLAY =========
    function showLoading(show){
      const ov = document.getElementById('loading-overlay');
      if(ov) ov.style.display = show ? 'flex' : 'none';
    }

    document.getElementById('form').onsubmit = async function(e){
      e.preventDefault();
      showLoading(true);
      try {
        const data = {
          tipoVistoria: document.getElementById('tipo-vistoria').value,
          nome: document.getElementById('nome').value,
          email: document.getElementById('email').value,
          nomeVistoriador: document.getElementById('nome-vistoriador').value,
          emailVistoriador: document.getElementById('email-locador').value,
          cidade: document.getElementById('cidade').value,
          dia: document.getElementById('dia').value,
          mes: document.getElementById('mes').value,
          ano: document.getElementById('ano').value,
          obra: document.getElementById('obra').value,
          local: document.getElementById('local').value,
          obsGerais: document.getElementById('obs-gerais').value,
          comodos: dadosComodos,
          moveis: moveis
        };
        await generateAndSend(data);
        alert("PDF gerado e baixado com sucesso!");
      } catch(err){
        console.error(err);
        alert("Erro ao gerar PDF.");
      } finally {
        showLoading(false);
      }
    };

    // ========= PDF DINÂMICO =========
    async function generateAndSend(data) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'mm', format: 'a4' });
      const margin = 18;
      const pageW = 210, pageH = 297;
      const maxWidth = pageW - margin*2;
      const corVermelha = [214,0,0];
      const LINE = 6;

      function addTextMulti(txt, x, y, fontSize=12, w=maxWidth, bold=false){
        doc.setFont('helvetica', bold ? 'bold' : 'normal');
        doc.setFontSize(fontSize);
        const lines = doc.splitTextToSize((txt && String(txt)) || '-', w);
        doc.text(lines, x, y);
        return { linesCount: lines.length, height: lines.length * LINE };
      }

      // Faixa topo
      doc.setFillColor(...corVermelha);
      doc.rect(0, 0, pageW, 30, 'F');
      doc.setFont('helvetica','bold'); doc.setTextColor(255,255,255);
      doc.setFontSize(22); doc.text('MSE ENGENHARIA', pageW/2, 18, {align:'center'});
      doc.setFontSize(13); doc.text('FICHA DE VISTORIA DE IMÓVEL', pageW/2, 26, {align:'center'});

      // Subtítulo
      doc.setFontSize(15); doc.setTextColor(...corVermelha);
      doc.text(
        (data.tipoVistoria && data.tipoVistoria.toUpperCase() === 'SAIDA') ? 'VISTORIA DE SAÍDA' : 'VISTORIA DE ENTRADA',
        pageW/2, 40, {align:'center'}
      );
      doc.setTextColor(0,0,0);

      // Bloco dados (dinâmico)
      let y = 48;
      const boxStartY = y;
      let linhaY = y + 8;

      addTextMulti("Nome:", margin+3, linhaY, 12, 30, true);
      let m = addTextMulti(data.nome, margin+35, linhaY, 12, maxWidth-35);
      linhaY += Math.max(LINE, m.height) + 1;

      addTextMulti("E-mail:", margin+3, linhaY, 12, 30, true);
      m = addTextMulti(data.email, margin+35, linhaY, 12, maxWidth-35);
      linhaY += Math.max(LINE, m.height) + 1;

      addTextMulti("Obra:", margin+3, linhaY, 12, 30, true);
      m = addTextMulti(data.obra, margin+35, linhaY, 12, maxWidth-35);
      linhaY += Math.max(LINE, m.height) + 1;

      addTextMulti("Endereço do Imóvel:", margin+3, linhaY, 12, 52, true);
      m = addTextMulti(data.local, margin+57, linhaY, 12, maxWidth-57);
      linhaY += Math.max(LINE, m.height) + 2;

      doc.setDrawColor(...corVermelha); doc.setLineWidth(0.4);
      doc.rect(margin, boxStartY, maxWidth, (linhaY - boxStartY) + 4);

      // Observações (dinâmico)
      y = linhaY + 10;
      doc.setFont('helvetica','bold'); doc.setTextColor(...corVermelha);
      doc.text('Observações Gerais', margin+2, y+7);
      doc.setDrawColor(...corVermelha); doc.setLineWidth(0.4);
      doc.setFont('helvetica','normal'); doc.setTextColor(0,0,0);

      const obs = (data.obsGerais && data.obsGerais.trim()) ? data.obsGerais : '-';
      const obsLines = doc.splitTextToSize(obs, maxWidth-6);
      const obsHeight = Math.max(LINE, obsLines.length * LINE) + 8;

      doc.rect(margin, y, maxWidth, obsHeight);
      doc.text(obsLines, margin+3, y+13);

      // Assinaturas (usam y final)
      let signY = y + obsHeight + 22;
      const longLine = { x1: 40, x2: 170 };
      const shortLine = { x1: 65, x2: 145 };

      doc.setDrawColor(...corVermelha); doc.setLineWidth(0.7);
      doc.line(longLine.x1, signY, longLine.x2, signY);
      doc.setFont('helvetica','normal'); doc.setFontSize(10); doc.setTextColor(90,90,90);
      doc.text('LOCATÁRIO - MSE ENGENHARIA', pageW/2, signY+6, {align:'center'});

      signY += 28;
      doc.line(shortLine.x1, signY, shortLine.x2, signY);
      doc.text('VISTORIADOR', pageW/2, signY+6, {align:'center'});

      signY += 28;
      doc.line(shortLine.x1, signY, shortLine.x2, signY);
      doc.text('LOCADOR', pageW/2, signY+6, {align:'center'});

      // Rodapé
      const cidadeDataTexto = `${data.cidade}, ${data.dia} de ${data.mes} de ${data.ano}`;
      doc.setFontSize(13); doc.setTextColor(120,0,0);
      doc.text(cidadeDataTexto, pageW - margin, pageH - 5, {align:'right'});

      // ---------- FICHAS POR CÔMODO ----------
      for (const comodo of Object.keys(data.comodos)) {
        const info = data.comodos[comodo];
        const temDados = Object.values(info.avaliacao).some(val => val && val !== '');
        const temFotos = info.fotos && info.fotos.length > 0;
        if (!temDados && !temFotos) continue;

        if (temDados) {
          doc.addPage();
          doc.setFontSize(15); doc.setFont('helvetica', 'bold'); doc.setTextColor(...corVermelha);
          doc.text(`Ficha de Avaliação – ${comodo.toUpperCase()}`, pageW/2, 18, {align:'center'});
          doc.setFontSize(12); doc.setTextColor(0,0,0);

          const table = [];
          for (const item of Object.keys(info.avaliacao)) {
            let val = info.avaliacao[item] || "-";
            table.push([item, val]);
          }
          doc.autoTable({
            startY: 28,
            head: [['Item', 'Estado de Conservação']],
            body: table,
            styles: { font: 'helvetica', fontSize: 12 },
            headStyles: { fillColor: corVermelha, textColor: 255, halign: 'center', fontStyle: 'bold' },
            margin: { left: margin, right: margin }
          });

          if (info.comentarios && info.comentarios.trim() !== "") {
            let posY = doc.lastAutoTable.finalY + 6;
            doc.setFont('helvetica', 'bold'); doc.setTextColor(...corVermelha);
            doc.text('Observações:', margin+2, posY);
            doc.setFont('helvetica', 'normal'); doc.setTextColor(0,0,0);
            addTextMulti(info.comentarios, margin+32, posY, 12, maxWidth-34);
          }
        }

        if (temFotos) {
          for (let i = 0; i < info.fotos.length; i++) {
            doc.addPage();
            doc.setFont('helvetica', 'bold'); doc.setTextColor(...corVermelha); doc.setFontSize(15);
            doc.text(comodo.toUpperCase(), pageW/2, 16, {align:'center'});
            await insertImageFull(doc, info.fotos[i]);
          }
        }

        for (const [item, avs] of Object.entries(info.avarias || {})) {
          if (avs && avs.length > 0) {
            for (const av of avs) {
              doc.addPage();
              doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.setTextColor(...corVermelha);
              doc.text(`${comodo.toUpperCase()} – ${item}`, pageW/2, 16, {align:'center'});
              doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.setTextColor(0,0,0);
              doc.text('Foto de Avaria', pageW/2, 24, {align:'center'});
              await insertImageFull(doc, av);
            }
          }
        }
      }

      // ---------- MÓVEIS ----------
      if (data.moveis && data.moveis.length > 0) {
        doc.addPage();
        doc.setFontSize(15); doc.setFont('helvetica', 'bold'); doc.setTextColor(...corVermelha);
        doc.text('Itens Mobiliados / Adicionais', pageW/2, 18, {align:'center'});
        doc.setFontSize(12); doc.setTextColor(0,0,0);
        doc.autoTable({
          startY: 28,
          head: [['Descrição', 'Cômodo', 'Estado de Conservação']],
          body: data.moveis.filter(mov=>mov.desc||mov.comodo||mov.estado).map(mov=>[mov.desc||'-', mov.comodo||'-', mov.estado||'-']),
          styles: { font: 'helvetica', fontSize: 12 },
          headStyles: { fillColor: corVermelha, textColor: 255, halign: 'center', fontStyle: 'bold' },
          margin: { left: margin, right: margin }
        });
      }

      if (data.moveis && data.moveis.length > 0) {
        for (const mov of data.moveis) {
          if (mov.fotos && mov.fotos.length > 0) {
            for (const foto of mov.fotos) {
              doc.addPage();
              doc.setFont('helvetica','bold'); doc.setFontSize(14); doc.setTextColor(...corVermelha);
              doc.text(`Avaria – ${mov.desc || 'Móvel'} (${mov.comodo || ''})`, pageW/2, 16, {align:'center'});
              doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.setTextColor(0,0,0);
              doc.text('Foto de Avaria de Móvel', pageW/2, 24, {align:'center'});
              await insertImageFull(doc, foto);
            }
          }
        }
      }

      doc.save(`Ficha_Vistoria_${data.nome || 'imovel'}.pdf`);

      async function insertImageFull(doc, dataUrl) {
        return new Promise(resolve => {
          let img = new Image();
          img.onload = function() {
            const pw = pageW - margin*2, ph = pageH - 38;
            let iw = img.width, ih = img.height;
            let ratio = Math.min(pw/iw, ph/ih);
            let w = iw*ratio, h = ih*ratio;
            let x = (pageW - w)/2, y = 30 + ((ph - h)/2);
            doc.addImage(img, 'JPEG', x, y, w, h);
            resolve();
          };
          img.src = dataUrl;
        });
      }
    }
  </script>
</body>
</html>
